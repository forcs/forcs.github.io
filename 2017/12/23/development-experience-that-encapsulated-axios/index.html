<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="http, axios, ajax, 前端," />










<meta name="description" content="前言前端开发中，如果页面需要与后台接口交互，并且无刷新页面，那么需要借助一下Ajax的http库来完成与后台数据接口的对接工作。在jQuery很盛行的时候，我们会使用$.ajax()，现在，可选择的就更多，例如：SuperAgent、Axios、Fetch…等等。有了这些http库，我们不在需要关注太多与ajax底层相关的细节的问题。很多时候和场景下，只需要关注如何构建一个request以及如何处">
<meta name="keywords" content="http, axios, ajax, 前端">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次对Axios进行封装的经历">
<meta property="og:url" content="http://zhangguoyu.org/2017/12/23/development-experience-that-encapsulated-axios/index.html">
<meta property="og:site_name" content="Forcs的记录">
<meta property="og:description" content="前言前端开发中，如果页面需要与后台接口交互，并且无刷新页面，那么需要借助一下Ajax的http库来完成与后台数据接口的对接工作。在jQuery很盛行的时候，我们会使用$.ajax()，现在，可选择的就更多，例如：SuperAgent、Axios、Fetch…等等。有了这些http库，我们不在需要关注太多与ajax底层相关的细节的问题。很多时候和场景下，只需要关注如何构建一个request以及如何处">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-1/29339878.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-1/55277877.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/16334636.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/27667192.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/80722640.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/40980416.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/87216751.jpg">
<meta property="og:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-2/30239455.jpg">
<meta property="og:updated_time" content="2018-01-07T14:24:40.382Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次对Axios进行封装的经历">
<meta name="twitter:description" content="前言前端开发中，如果页面需要与后台接口交互，并且无刷新页面，那么需要借助一下Ajax的http库来完成与后台数据接口的对接工作。在jQuery很盛行的时候，我们会使用$.ajax()，现在，可选择的就更多，例如：SuperAgent、Axios、Fetch…等等。有了这些http库，我们不在需要关注太多与ajax底层相关的细节的问题。很多时候和场景下，只需要关注如何构建一个request以及如何处">
<meta name="twitter:image" content="http://oz04bqks1.bkt.clouddn.com/18-1-1/29339878.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhangguoyu.org/2017/12/23/development-experience-that-encapsulated-axios/"/>





  <title>记一次对Axios进行封装的经历 | Forcs的记录</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Forcs的记录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhangguoyu.org/2017/12/23/development-experience-that-encapsulated-axios/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Forcs Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forcs的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">记一次对Axios进行封装的经历</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-23T23:07:01+08:00">
                2017-12-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前端开发中，如果页面需要与后台接口交互，并且无刷新页面，那么需要借助一下Ajax的http库来完成与后台数据接口的对接工作。在<code>jQuery</code>很盛行的时候，我们会使用<code>$.ajax()</code>，现在，可选择的就更多，例如：<a href="http://visionmedia.github.io/superagent/" target="_blank" rel="noopener"><code>SuperAgent</code></a>、<a href="https://github.com/axios/axios" target="_blank" rel="noopener"><code>Axios</code></a>、<a href="https://github.github.io/fetch/" target="_blank" rel="noopener"><code>Fetch</code></a>…等等。有了这些http库，我们不在需要关注太多与ajax底层相关的细节的问题。很多时候和场景下，只需要关注如何构建一个request以及如何处理一个response即可，但即便这些http库已经在一定程度上简化了我们的开发工作，我们仍然需要针对项目的实际需要，团队内部技术规范对这些http库进行封装，进而优化我们的开发效率。</p>
<p>本文将结合我们团队使用的一个http库<code>Axios</code>和我们团队开发工程的一些场景，分享我们前端团队对http库进行封装的经历。</p>
<h2 id="对http库进行基本的封装"><a href="#对http库进行基本的封装" class="headerlink" title="对http库进行基本的封装"></a>对http库进行基本的封装</h2><h4 id="服务端URL接口的定义"><a href="#服务端URL接口的定义" class="headerlink" title="服务端URL接口的定义"></a>服务端URL接口的定义</h4><p>以用户管理模块为例。对于用户管理模块，服务端通常会定义如下接口：</p>
<ul>
<li><code>GET /users?page=0&amp;size=20</code> - 获取用户信息的分页列表</li>
<li><code>GET /users/all</code> - 获取所有的用户信息列表</li>
<li><code>GET /users/:id</code> - 获取指定<code>id</code>的用户信息</li>
<li><code>POST /users application/x-www-form-urlencoded</code> - 创建用户</li>
<li><code>PUT /users/:id application/x-www-form-urlencoded</code> - 更新指定id的用户信息</li>
<li><code>DELETE /users/:id</code> 删除指定<code>id</code>的用户信息</li>
</ul>
<p>通过以上定义，不难发现这些都是基于RESTful标准进行定义的接口。</p>
<h4 id="将接口进行模块化封装"><a href="#将接口进行模块化封装" class="headerlink" title="将接口进行模块化封装"></a>将接口进行模块化封装</h4><p>针对这样一个用户管理模块，我们首先需要做的就是定义一个用户管理模块类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserManager.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span>  <span class="comment">// 当然，这个地址是虚拟的</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 修改POST和PUT请求默认的Content-Type，根据自己项目后端的定义而定，不一定需要</span></span><br><span class="line">    <span class="keyword">this</span>.dataMethodDefaults = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> UserManager()  <span class="comment">// 单例模块</span></span><br></pre></td></tr></table></figure>
<p>在<code>UserManager</code>的构造函数中，我们设置了一些请求的公共参数，比如接口的<code>baseUrl</code>，这样后面在发起请求的时候，URL只需要使用相对路径即可。与此同时，我们还调整了POST请求和PUT请求默认的<code>Content-Type</code>。<code>Axios</code>默认是<code>application/json</code>，我们根据后端接口的定义，将其调整成了表单类型<code>application/x-www-form-urlencoded</code>。最后，借助ES6模块化的特性，我们将<code>UserManager</code>单例化。</p>
<blockquote>
<p>实际的场景中，一套符合行业标准的后端接口规范要比这复杂得多。由于这些内容不是本文讨论的重点，所以简化了。</p>
</blockquote>
<p>接着，给<code>UserManager</code>添加调用接口的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.dataMethodDefaults = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUsersPageableList (page = <span class="number">0</span>, size = <span class="number">20</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/users?page=<span class="subst">$&#123;page&#125;</span>&amp;size=<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUsersFullList () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">'/users/all'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUser (id) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`getUser：id(<span class="subst">$&#123;id&#125;</span>)无效`</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/users/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  createUser (data = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!data || !<span class="built_in">Object</span>.keys(data).length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createUser：提交的数据无效'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.post(<span class="string">'/users'</span>, data, &#123; ...this.dataMethodDefaults &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  updateUser (id, update = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!update || !<span class="built_in">Object</span>.keys(update).length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'updateUser：提交的数据无效'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.put(<span class="string">`/users/<span class="subst">$&#123;id&#125;</span>`</span>, update, &#123; ...this.dataMethodDefaults &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  deleteUser (id) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`deleteUser：id(<span class="subst">$&#123;id&#125;</span>)无效`</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.delete(<span class="string">`/users/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> UserManager()</span><br></pre></td></tr></table></figure>
<p>新增的方法没有什么特别的地方，一目了然，就是通过<code>Axios</code>执行http请求调用服务端的接口。值得注意的是，在<code>getUser()</code>、<code>createUser()</code>、<code>updateUser()</code>、<code>deleteUser()</code>这四个方法中，我们对参数进行了简单的验证，当然，实际的场景会比范例代码的更加复杂些，其实参数验证不是重点，关键在于验证的<code>if</code>语句块中，<code>return</code>的是一个<code>Promise</code>对象，这是为了和<code>Axios</code>的API保持一致。</p>
<h4 id="前端调用封装的方法"><a href="#前端调用封装的方法" class="headerlink" title="前端调用封装的方法"></a>前端调用封装的方法</h4><p>经过这样封装后，前端页面与服务端交互就变得简单多了。下面以Vue版本的前端代码为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src/components/UserManager.vue --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 模板代码可以忽略 --&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import userManager from &apos;../services/UserManager&apos;</span><br><span class="line">  export default &#123;</span><br><span class="line">    data () &#123;</span><br><span class="line">      userList: [],</span><br><span class="line">      currentPage: 0,</span><br><span class="line">      currentPageSize: 20,</span><br><span class="line">      formData: &#123;</span><br><span class="line">      	account: &apos;&apos;,</span><br><span class="line">        nickname: &apos;&apos;,</span><br><span class="line">        email: &apos;&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    _getUserList () &#123;</span><br><span class="line">      userManager.getUser(this.currentPage, this.currentPageSize)</span><br><span class="line">      .then(response =&gt; &#123;</span><br><span class="line">        this.userList = response.data</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        console.error(err.message)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted () &#123;</span><br><span class="line">      // 加载页面的时候，获取用户列表</span><br><span class="line">      this._getUserList()</span><br><span class="line">    &#125;,</span><br><span class="line">    handleCreateUser () &#123;</span><br><span class="line">      // 提交创建用户的表单</span><br><span class="line">      userManager.createUser(&#123; ...this.formData &#125;)</span><br><span class="line">      .then(response =&gt; &#123;</span><br><span class="line">        // 刷新列表</span><br><span class="line">        this._getUserList()</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        console.error(err.message)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>当然，类似的js代码在React版本的前端页面上也是适用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// src/components/UserList.js</span><br><span class="line">import React from &apos;react&apos;</span><br><span class="line">import userManager from &apos;../servers/UserManager&apos;</span><br><span class="line"></span><br><span class="line">class UserManager extends React.Compnent &#123;</span><br><span class="line">  constructor (props) &#123;</span><br><span class="line">    super(props)</span><br><span class="line">    this.state.userList = []</span><br><span class="line">    this.handleCreateUser = this.handleCreateUser.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  _getUserList () &#123;</span><br><span class="line">    userManager.getUser(this.currentPage, this.currentPageSize)</span><br><span class="line">    .then(response =&gt; &#123;</span><br><span class="line">      this.setState(&#123; userList: userList = response.data &#125;)</span><br><span class="line">    &#125;).catch(err =&gt; &#123;</span><br><span class="line">      console.error(err.message)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    this._getUserList()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  handleCreateUser (data) &#123;</span><br><span class="line">    userManager.createUser(&#123; ...data &#125;)</span><br><span class="line">    .then(response =&gt; &#123;</span><br><span class="line">      this._getUserList()</span><br><span class="line">    &#125;).catch(err =&gt; &#123;</span><br><span class="line">      console.error(err.message)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  render () &#123;</span><br><span class="line">    // 模板代码就可以忽略了</span><br><span class="line">    return (/* ...... */)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">            </span><br><span class="line">export default UserManager</span><br></pre></td></tr></table></figure>
<p>为了节省篇幅，后面就不再展示前端页面上调用封装模块的代码了。</p>
<p>ok，接口用起来很方便，封装到这一步感觉似乎没啥毛病。可是，一个APP怎么可能就这么些接口呢，它会涉及到若干个接口，而不同的接口可能归类在不同的模块。就拿我们的后台项目来说，内容管理模块就分为单片管理和剧集管理，剧集管理即包括剧集实体自身的管理，也包括对单片进行打包的管理，所以，后台对内容管理模块的接口定义如下：</p>
<p><strong>单片管理</strong>：</p>
<ul>
<li><code>GET /videos?page=0&amp;size=20</code></li>
<li><code>GET /videos/all</code></li>
<li><code>GET /videos/:id</code></li>
<li><code>POST /videos application/x-www-form-urlencoded</code></li>
<li><code>PUT /videos/:id application/x-www-form-urlencoded</code></li>
<li><code>DELETE /videos/:id</code> </li>
</ul>
<p><strong>剧集管理：</strong></p>
<ul>
<li><code>GET /episodes?page=0&amp;size=20</code></li>
<li><code>GET /episodes/all</code></li>
<li><code>GET /episodes/:id</code></li>
<li><code>POST /episodes application/x-www-form-urlencoded</code></li>
<li><code>PUT /episodes/:id application/x-www-form-urlencoded</code></li>
<li><code>DELETE /episodes/:id</code></li>
</ul>
<p>篇幅关系，就不列出所有的接口了。可以看到接口依然是按照RESTful标准来定义的。按照之前说的做法，我们可以立即对这些接口进行封装。</p>
<p>定义一个单品管理的模块类<code>VideoManager</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VideoManager.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.dataMethodDefaults = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideosPageableList (page = <span class="number">0</span>, size = <span class="number">20</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/videos?page=<span class="subst">$&#123;page&#125;</span>&amp;size=<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideosFullList () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">'/videos/all'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideo (id) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`getVideo：id(<span class="subst">$&#123;id&#125;</span>)无效`</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/videos/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 篇幅原因，后面的接口省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> VideoManager()</span><br></pre></td></tr></table></figure>
<p>以及剧集管理的模块类<code>EpisodeManager.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EpisodeManager.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EpisodeManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.dataMethodDefaults = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisodesPageableList (page = <span class="number">0</span>, size = <span class="number">20</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/episodes?page=<span class="subst">$&#123;page&#125;</span>&amp;size=<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisodesFullList () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">'/episodes/all'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisode (id) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`getEpisode：id(<span class="subst">$&#123;id&#125;</span>)无效`</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(<span class="string">`/episodes/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 篇幅原因，后面的接口省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> EpisodeManager()</span><br></pre></td></tr></table></figure>
<p>发现问题了吗？存在重复的代码，会给后期的维护埋下隐患。编程原则中，有一个很著名的原则：<a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener"><strong>DRY</strong></a>，翻译过来就是要尽可能的避免重复的代码。在灵活的前端开发中，要更加留意这条原则，重复的代码越多，维护的成本越大，灵活度和健壮性也随之降低。想想要是大型的APP涉及到的模块有数十个以上，每个模块都撸一遍这样的代码，如果后期公共属性有啥调整的话，这样的改动简直就是个灾难！</p>
<p>为了提升代码的复用性，灵活度，减少重复的代码，应该怎么做呢？如果了解OOP的话，你应该可以很快想出对——定义一个父类，抽离公共部分。</p>
<h2 id="让封装的模块更具备复用性"><a href="#让封装的模块更具备复用性" class="headerlink" title="让封装的模块更具备复用性"></a>让封装的模块更具备复用性</h2><h4 id="使用继承的方式进行重构"><a href="#使用继承的方式进行重构" class="headerlink" title="使用继承的方式进行重构"></a>使用继承的方式进行重构</h4><p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-1/29339878.jpg" alt=""></p>
<p>定义一个父类<code>BaseModule</code>，将代码公共的部分都放到这个父类中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseModule.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.dataMethodDefaults = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  get (url, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.get(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  post (url, data = <span class="literal">undefined</span>, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.post(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  put (url, data = <span class="literal">undefined</span>, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.put(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">delete</span> (url, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.delete(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> BaseModule</span><br></pre></td></tr></table></figure>
<p>然后让<code>UserManager</code>、<code>VideoManager</code>、<code>EpisodeManager</code>都继承自这个<code>BaseModule</code>，移除重复的代码。</p>
<p><code>UserManager.js</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import BaseModule from './BaseModule'</span></span><br><span class="line"><span class="deletion">- import axios from 'axios'</span></span><br><span class="line"><span class="deletion">- import qs from 'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+  class UserManager extends BaseModule &#123;</span></span><br><span class="line"><span class="deletion">-  class UserManager &#123;</span></span><br><span class="line">    constructor() &#123;</span><br><span class="line"><span class="addition">+    super()</span></span><br><span class="line"><span class="deletion">-    this.$http = axios.create(&#123;</span></span><br><span class="line"><span class="deletion">-      baseUrl: 'https://api.forcs.com'</span></span><br><span class="line"><span class="deletion">-    &#125;)</span></span><br><span class="line"><span class="deletion">-	this.dataMethodDefaults = &#123;</span></span><br><span class="line"><span class="deletion">-      headers: &#123;</span></span><br><span class="line"><span class="deletion">-        'Content-Type': 'application/x-www-form-urlencoded'</span></span><br><span class="line"><span class="deletion">-      &#125;,</span></span><br><span class="line"><span class="deletion">-      transformRequest: [function (data) &#123;</span></span><br><span class="line"><span class="deletion">-        return qs.stringify(data)</span></span><br><span class="line"><span class="deletion">-      &#125;]</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUsersPageableList (page = 0, size = 20) &#123;</span><br><span class="line"><span class="addition">+    return this.get(`/users?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/users?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUsersFullList () &#123;</span><br><span class="line"><span class="addition">+    return this.get('/users/all')</span></span><br><span class="line"><span class="deletion">-    return this.$http.get('/users/all')</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getUser (id) &#123;</span><br><span class="line">    if (!id) &#123;</span><br><span class="line">      return Promise.reject(new Error(`getUser：id($&#123;id&#125;)无效`))</span><br><span class="line">    &#125;</span><br><span class="line"><span class="addition">+    return this.get(`/users/$&#123;id&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/users/$&#123;id&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default new UserManager()</span><br></pre></td></tr></table></figure>
<p><code>VideoManager.js</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import BaseModule from './BaseModule'</span></span><br><span class="line"><span class="deletion">- import axios from 'axios'</span></span><br><span class="line"><span class="deletion">- import qs from 'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+ class VideoManager extends BaseModule &#123;</span></span><br><span class="line"><span class="deletion">- class VideoManager &#123;</span></span><br><span class="line">  constructor () &#123;</span><br><span class="line"><span class="addition">+    super()</span></span><br><span class="line"><span class="deletion">-    this.$http = axios.create(&#123;</span></span><br><span class="line"><span class="deletion">-      baseUrl: 'https://api.forcs.com'</span></span><br><span class="line"><span class="deletion">-    &#125;)</span></span><br><span class="line"><span class="deletion">-	this.dataMethodDefaults = &#123;</span></span><br><span class="line"><span class="deletion">-      headers: &#123;</span></span><br><span class="line"><span class="deletion">-        'Content-Type': 'application/x-www-form-urlencoded'</span></span><br><span class="line"><span class="deletion">-      &#125;,</span></span><br><span class="line"><span class="deletion">-      transformRequest: [function (data) &#123;</span></span><br><span class="line"><span class="deletion">-        return qs.stringify(data)</span></span><br><span class="line"><span class="deletion">-      &#125;]</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideosPageableList (page = 0, size = 20) &#123;</span><br><span class="line"><span class="addition">+    return this.get(`/videos?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/videos?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideosFullList () &#123;</span><br><span class="line"><span class="addition">+    return this.get('/videos/all')</span></span><br><span class="line"><span class="deletion">-    return this.$http.get('/videos/all')</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getVideo (id) &#123;</span><br><span class="line">    if (!id) &#123;</span><br><span class="line">      return Promise.reject(new Error(`getVideo：id($&#123;id&#125;)无效`))</span><br><span class="line">    &#125;</span><br><span class="line"><span class="addition">+    return this.get(`/videos/$&#123;id&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/videos/$&#123;id&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default new VideoManager()</span><br></pre></td></tr></table></figure>
<p><code>EpisodeManager.js</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import BaseModule from './BaseModule'</span></span><br><span class="line"><span class="deletion">- import axios from 'axios'</span></span><br><span class="line"><span class="deletion">- import qs from 'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+ class EpisodeManager extends BaseModule &#123;</span></span><br><span class="line"><span class="deletion">- class EpisodeManager &#123;</span></span><br><span class="line">  constructor () &#123;</span><br><span class="line"><span class="addition">+    super()</span></span><br><span class="line"><span class="deletion">-    this.$http = axios.create(&#123;</span></span><br><span class="line"><span class="deletion">-      baseUrl: 'https://api.forcs.com'</span></span><br><span class="line"><span class="deletion">-    &#125;)</span></span><br><span class="line"><span class="deletion">-	this.dataMethodDefaults = &#123;</span></span><br><span class="line"><span class="deletion">-      headers: &#123;</span></span><br><span class="line"><span class="deletion">-        'Content-Type': 'application/x-www-form-urlencoded'</span></span><br><span class="line"><span class="deletion">-      &#125;,</span></span><br><span class="line"><span class="deletion">-      transformRequest: [function (data) &#123;</span></span><br><span class="line"><span class="deletion">-        return qs.stringify(data)</span></span><br><span class="line"><span class="deletion">-      &#125;]</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisodesPageableList (page = 0, size = 20) &#123;</span><br><span class="line"><span class="addition">+    return this.get(`/episodes?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/episodes?page=$&#123;page&#125;&amp;size=$&#123;size&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisodesFullList () &#123;</span><br><span class="line"><span class="addition">+    return this.get('/episodes/all')</span></span><br><span class="line"><span class="deletion">-    return this.$http.get('/episodes/all')</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  getEpisode (id) &#123;</span><br><span class="line">    if (!id) &#123;</span><br><span class="line">      return Promise.reject(new Error(`getEpisode：id($&#123;id&#125;)无效`))</span><br><span class="line">    &#125;</span><br><span class="line"><span class="addition">+    return this.get(`/episodes/$&#123;id&#125;`)</span></span><br><span class="line"><span class="deletion">-    return this.$http.get(`/episodes/$&#123;id&#125;`)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // ... 篇幅原因，后面的接口省略</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default new EpisodeManager()</span><br></pre></td></tr></table></figure>
<p>利用OOP的继承特性，将公共代码抽离到父类中，使得封装模块接口的代码得到一定程度的简化，以后如果接口的公共部分的默认属性有何变动，只需要维护<code>BaseModule</code>即可。如果你对<code>BaseModule</code>有留意的话，应该会注意到，<code>BaseModule</code>也不完全将公共部分隐藏在自身当中。同时，<code>BaseModule</code>还对<code>Axios</code>对象的代理方法（<code>axios.get()</code>、<code>axios.post()</code>、<code>axios.put()</code>、<code>axios.delete()</code>）进行了包装，从而将<code>Axios</code>内聚在自身内部，减少子类的依赖层级。对于子类，不再需要关心<code>Axios</code>对象，只需要关心父类提供的方法和部分属性即可。这样做，一方面提升了父类的复用性，另一方面也使得子类可以更加好对父类进行扩展，同时又不影响到其他子类。</p>
<p>对于一般场景，封装到这里，此役也算是可以告捷，终于可以去冲杯咖啡小歇一会咯。不过，公司还没跨，事情怎么可能完呢……</p>
<h4 id="BaseModule的问题"><a href="#BaseModule的问题" class="headerlink" title="BaseModule的问题"></a>BaseModule的问题</h4><p>过了一周后，新项目启动，这个项目对接的是另一个后端团队的接口。大体上还好，接口命名风格依然基本跟着RESTful的标准走，可是，请求地址的域名换了，请求头的<code>Content-Type</code>也和之前团队定义的不一样，这个后端团队用的是<code>application/json</code>。</p>
<blockquote>
<p>当然，实际上不同的后端团队定义的接口，差异未必会这么小:(</p>
</blockquote>
<p>面对这种场景，我们的第一反应可能是：好撸，把之前项目的<code>BaseModule</code>复制到现在的项目中，调整一下就好了。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import axios from 'axios'</span><br><span class="line">import qs from 'query-string'</span><br><span class="line"></span><br><span class="line">class BaseModule &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    this.$http = axios.create(&#123;</span><br><span class="line"><span class="deletion">-      baseUrl: 'https://api.forcs.com'</span></span><br><span class="line"><span class="addition">+      baseUrl: 'https://api2.forcs.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="deletion">-	this.dataMethodDefaults = &#123;</span></span><br><span class="line"><span class="deletion">-      headers: &#123;</span></span><br><span class="line"><span class="deletion">-        'Content-Type': 'application/x-www-form-urlencoded'</span></span><br><span class="line"><span class="deletion">-      &#125;,</span></span><br><span class="line"><span class="deletion">-      transformRequest: [function (data) &#123;</span></span><br><span class="line"><span class="deletion">-        return qs.stringify(data)</span></span><br><span class="line"><span class="deletion">-      &#125;]</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  get (url, config = &#123;&#125;) &#123;</span><br><span class="line">    return this.$http.get(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  post (url, data = undefined, config = &#123;&#125;) &#123;</span><br><span class="line"><span class="deletion">-   return this.$http.post(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span></span><br><span class="line"><span class="addition">+   return this.$http.post(url, data, config)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  put (url, data = undefined, config = &#123;&#125;) &#123;</span><br><span class="line"><span class="deletion">-  	return this.$http.post(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span></span><br><span class="line"><span class="addition">+   return this.$http.put(url, data, config)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  delete (url, config = &#123;&#125;) &#123;</span><br><span class="line">    return this.$http.delete(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default BaseModule</span><br></pre></td></tr></table></figure>
<p>由于<code>Axios</code>默认POST和PUT请求Header的<code>Content-Type</code>是<code>application/json</code>，所以只需要将之前设置<code>Content-Type</code>的代码移除即可。接着，就可以喝着咖啡，听着歌，愉快的封装接口对接数据了！</p>
<p>认真回想一下，这样做其实又了我们之前提到一个问题：<strong>重复的代码</strong>。你可能认为，反正不是一个项目的，代码独立维护，所以这样也不打紧。我从客观的角度认为，对于一些小项目或者小团队，这样做的确没啥毛病，但如果，我是说如果，项目越来越多了，这样每个项目复制一套代码真的好吗？假如哪天后端团队做了统一规范，所有接口的请求头都按照一套规范来设置，其实之前的代码都得逐一调整？我的天，这得多大工作量。总之，<strong>重复的代码就是个坑！</strong></p>
<p>应对这种情况，怎么破？</p>
<h2 id="让封装的模块更具备通用性"><a href="#让封装的模块更具备通用性" class="headerlink" title="让封装的模块更具备通用性"></a>让封装的模块更具备通用性</h2><p>在面向对象编程的原则中，有这么一条：<strong>开闭原则</strong>。即对扩展开发，对修改关闭。根据这条原则，我想到的一个方案，就是给封装的<code>BaseModule</code>提供对外设置的选项，就像jQuery的大多数插件那样，工厂方法中都会提供一个<code>options</code>对象参数，方便外层调整插件的部分属性。我们也可以对<code>BaseModule</code>进行一些改造，让它更灵活，更易于扩展。</p>
<h4 id="对BaseModule进行重构"><a href="#对BaseModule进行重构" class="headerlink" title="对BaseModule进行重构"></a>对BaseModule进行重构</h4><p>接下来需要对之前的<code>BaseModule</code>进行重构，让它更具备通用性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'query-string'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isEmptyObject</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !obj || !<span class="built_in">Object</span>.keys(obj).length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理headers中不需要的属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearUpHeaders</span> (<span class="params">headers</span>) </span>&#123;</span><br><span class="line">  [</span><br><span class="line">    <span class="string">'common'</span>,</span><br><span class="line">    <span class="string">'get'</span>,</span><br><span class="line">    <span class="string">'post'</span>,</span><br><span class="line">    <span class="string">'put'</span>,</span><br><span class="line">    <span class="string">'delete'</span>,</span><br><span class="line">    <span class="string">'patch'</span>,</span><br><span class="line">    <span class="string">'options'</span>,</span><br><span class="line">    <span class="string">'head'</span></span><br><span class="line">  ].forEach(<span class="function"><span class="params">prop</span> =&gt;</span> headers[prop] &amp;&amp; <span class="keyword">delete</span> headers[prop])</span><br><span class="line">  <span class="keyword">return</span> headers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合请求方法的headers</span></span><br><span class="line"><span class="comment">// headers = default &lt;= common &lt;= method &lt;= extra</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveHeaders</span> (<span class="params">method, defaults = &#123;&#125;, extras = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  method = method &amp;&amp; method.toLowerCase()</span><br><span class="line">  <span class="comment">// check method参数的合法性</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/^(get|post|put|delete|patch|options|head)$/</span>.test(method)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`method:<span class="subst">$&#123;method&#125;</span>不是合法的请求方法`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> headers = &#123; ...defaults &#125;</span><br><span class="line">  <span class="keyword">const</span> commonHeaders = headers.common || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> headersForMethod = headers[method] || &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> _clearUpHeaders(&#123;</span><br><span class="line">    ...headers,</span><br><span class="line">    ...commonHeaders,</span><br><span class="line">    ...headersForMethod,</span><br><span class="line">    ...extras</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合请求方法的config</span></span><br><span class="line"><span class="comment">// config = default &lt;= extra</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveConfig</span> (<span class="params">method, defaults = &#123;&#125;, extras = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isEmptyObject(defaults) &amp;&amp; isEmptyObject(extras)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...defaults,</span><br><span class="line">    ...extras,</span><br><span class="line">    resolveHeaders(method, defaults.headers, extras.headers)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClientModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultHeaders = options.headers || &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (options.headers) &#123;</span><br><span class="line">      <span class="keyword">delete</span> options.headers</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      baseUrl: <span class="string">'https://api.forcs.com'</span>,</span><br><span class="line">      transformRequest: [<span class="function"><span class="keyword">function</span> (<span class="params">data, headers</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (headers[<span class="string">'Content-Type'</span>] === <span class="string">'application/x-www-form-urlencoded'</span>) &#123;</span><br><span class="line">          <span class="comment">// 针对application/x-www-form-urlencoded对data进行序列化</span></span><br><span class="line">          <span class="keyword">return</span> qs.stringify(data)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> data</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.defaultConfig = &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</span><br><span class="line">      	...defaultHeaders</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.$http = axios.create(&#123; ...defaultOptions, ...options &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  get (url, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="keyword">this</span>.$http.get(url, resolveConfig(</span><br><span class="line">        <span class="string">'get'</span>, <span class="keyword">this</span>.defaultConfig, config)))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  post (url, data = <span class="literal">undefined</span>, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="keyword">this</span>.$http.post(url, data, resolveConfig(</span><br><span class="line">        <span class="string">'post'</span>, <span class="keyword">this</span>.defaultConfig, config)))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  put (url, data = <span class="literal">undefined</span>, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="keyword">this</span>.$http.put(url, data, resolveConfig(</span><br><span class="line">        <span class="string">'put'</span>, <span class="keyword">this</span>.defaultConfig, config)))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">delete</span> (url, config = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="keyword">this</span>.$http.delete(url, resolveConfig(</span><br><span class="line">        <span class="string">'delete'</span>, <span class="keyword">this</span>.defaultConfig, config)))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出工厂方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHttpClient</span> (<span class="params">options, defaults</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HttpClientModule(options, defaults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认导出模块对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> HttpClientModule  <span class="comment">// import</span></span><br></pre></td></tr></table></figure>
<p>经过重构的<code>BaseModule</code>已经面目全非，模块的名称也换成了更加通用的叫法：<code>HttpClientModule</code>。<code>HttpClientModule</code>的构造函数提供了一个<code>options</code>参数，为了减少模块的学习成本，<code>options</code>基本沿用了<code>Axios</code>的<a href="https://github.com/axios/axios#request-config" target="_blank" rel="noopener">Request Config</a>定义的结构体。唯独有一点不同，就是对<code>options</code>的<code>headers</code>属性处理。</p>
<p>这里需要多说一下，看似完美的<code>Axios</code>存在一个比较严重，但至今还没修复的bug，就是通过<code>defaults</code>属性<a href="https://github.com/axios/axios#config-defaults" target="_blank" rel="noopener">设置headers</a>是不起作用的，必须在执行请求操作（调用<code>request()</code>、<code>get()</code>、<code>post()</code>…等请求方法）时，通过方法的<code>config</code>参数设置header才会生效。为了规避这个特性的bug，我在<code>HttpClientModule</code>这个模块中，按照<code>Axios</code>的API设计，自己手动实现了类似的features。既可以通过<code>common</code>属性设置公共的header，也可以以请求方法名（get、post、put…等）作为属性名来给特定请求方法的请求设置默认的header。大概像下面这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="comment">// 设置公共的header</span></span><br><span class="line">    common: &#123;</span><br><span class="line">      Authorization: AUTH_TOKEN</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 为post和put请求设置请求时的Content-Type</span></span><br><span class="line">    post: &#123;</span><br><span class="line">      <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    put: &#123;</span><br><span class="line">      <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpClient = <span class="keyword">new</span> HttpClientModule(options)</span><br></pre></td></tr></table></figure>
<h4 id="独立发布重构的封装模块"><a href="#独立发布重构的封装模块" class="headerlink" title="独立发布重构的封装模块"></a>独立发布重构的封装模块</h4><p>我们可以为<code>HttpClientModule</code>单独创建一个npm项目，给它取一个名词，例如<code>httpclient-module</code>。取名前最好先上npmjs上查一下名称是否已经被其它模块使用了，尽量保持名称的唯一性。然后通过<a href="https://webpack.js.org/" target="_blank" rel="noopener">webpack</a>、<a href="https://rollupjs.org/" target="_blank" rel="noopener">rollup</a>、<a href="https://parceljs.org/" target="_blank" rel="noopener">parcel</a>等构建工具进行打包，<a href="https://docs.npmjs.com/getting-started/publishing-npm-packages" target="_blank" rel="noopener">发布到npmjs上</a>。当然，如果代码中涉及到私有的配置信息，也可以<a href="https://www.npmjs.com/package/sinopia" target="_blank" rel="noopener">自己搭建一个npm私服仓库</a>，然后布到私服上。这样，就可以通过<code>npm install</code>命令直接将模块安装到我们的项目中来使用了。安装模块可以通过如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install httpclient-module --save</span><br><span class="line"><span class="meta">#</span> or</span><br><span class="line">npm i httpclient-module -S</span><br></pre></td></tr></table></figure>
<h4 id="对业务接口层的模块进行调整"><a href="#对业务接口层的模块进行调整" class="headerlink" title="对业务接口层的模块进行调整"></a>对业务接口层的模块进行调整</h4><p>还记得前面针对业务层定义的<code>UserManager</code>、<code>VideoManager</code>以及<code>EpisodeManager</code>吗，他们都继承自<code>BaseModule</code>，但为了让父类<code>BaseModule</code>更具通用性，我们以及将它进行了重构，并且换了个名称进行了独立发布，那么这几个业务层的manager模块应该如何使用这个经过重构的模块<code>HttpClientModule</code>呢？</p>
<p>因为那些manager模块都继承自父类<code>BaseModule</code>，我们只需要对<code>BaseModule</code>进行调整即可。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- import axios from 'axios'</span></span><br><span class="line"><span class="deletion">- import qs from 'query-string'</span></span><br><span class="line"><span class="addition">+ import &#123; createHttpClient &#125; from 'httpclient-module'</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+ const P_CONTENT_TYPE = 'application/x-www-form-urlencoded'</span></span><br><span class="line">class BaseModule &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line"><span class="deletion">-    this.$http = axios.create(&#123;</span></span><br><span class="line"><span class="deletion">-      baseUrl: 'https://api.forcs.com'</span></span><br><span class="line"><span class="deletion">-    &#125;)</span></span><br><span class="line"><span class="deletion">-    this.dataMethodDefaults = &#123;</span></span><br><span class="line"><span class="deletion">-      headers: &#123;</span></span><br><span class="line"><span class="deletion">-        'Content-Type': 'application/x-www-form-urlencoded'</span></span><br><span class="line"><span class="deletion">-      &#125;,</span></span><br><span class="line"><span class="deletion">-      transformRequest: [function (data) &#123;</span></span><br><span class="line"><span class="deletion">-        return qs.stringify(data)</span></span><br><span class="line"><span class="deletion">-      &#125;]</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line"><span class="addition">+    this.$http = createHttpClient(&#123;</span></span><br><span class="line"><span class="addition">+      headers: &#123;</span></span><br><span class="line"><span class="addition">+        post: &#123; 'Content-Type': P_CONTENT_TYPE &#125;,</span></span><br><span class="line"><span class="addition">+        put: &#123; 'Content-Type': P_CONTENT_TYPE &#125;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  get (url, config = &#123;&#125;) &#123;</span><br><span class="line">    return this.$http.get(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  post (url, data = undefined, config = &#123;&#125;) &#123;</span><br><span class="line"><span class="deletion">-    return this.$http.post(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span></span><br><span class="line"><span class="addition">+    return this.$http.post(url, data, config)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  put (url, data = undefined, config = &#123;&#125;) &#123;</span><br><span class="line"><span class="deletion">-    return this.$http.put(url, data, &#123; ...this.dataMethodDefaults, ...config &#125;)</span></span><br><span class="line"><span class="addition">+    return this.$http.put(url, data, config)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  delete (url, config = &#123;&#125;) &#123;</span><br><span class="line">    return this.$http.delete(url, config)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default BaseModule</span><br></pre></td></tr></table></figure>
<p>本质上就是用自己封装的<code>httpclient-module</code>替换了原来的<code>Axios</code>。这样有什么好处呢？</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-1/55277877.jpg" alt=""></p>
<p><code>httpclient-module</code>可以认为是<code>Axios</code>与业务接口层之间的适配器。将<code>Axios</code>封装到<code>httpclient-module</code>，降低了前端项目对第三方库的依赖。前面有提到<code>Axios</code>是存在一些比较明显的bug的，经过这层封装，我们可以降低bug对项目的影响，只需要维护<code>httpclient-module</code>，就可以规避掉第三方bug带来的影响。如果以后发现有更好的http库，需要替换掉<code>Axios</code>，只需要升级<code>httpclient-module</code>就可以了。对于业务层，不需要做太大的调整。</p>
<p>有了<code>httpclient-module</code>这层适配器，也给团队做技术统一化规范带来方便。假如以后团队的接口规范做了调整，比如接口域名切换到https，请求头认证做统一调整，或者请求头需要增减其他参数，也只需要更新<code>httpclient-module</code>就好。如果不是团队做统一调整，而是个别项目，也只需要调整<code>BaseModule</code>，修改一下传递给<code>httpclient-module</code>的<code>options</code>参数即可。</p>
<h2 id="让封装的模块提高我们开发效率"><a href="#让封装的模块提高我们开发效率" class="headerlink" title="让封装的模块提高我们开发效率"></a>让封装的模块提高我们开发效率</h2><p>用<code>httpclient-module</code>愉快的工作了一段时间后，我们又遇到了新的问题。</p>
<p>随着项目迭代，前端加入的业务功能越来越多，需要对接后台的业务接口也逐渐增多。比如新增一个内容供应商管理模块，我们就需要为此创建一个<code>CPManager</code>，然后添加调用接口请求的方法，新增一个内容标签管理模块，就需要定义一个<code>TagManager</code>，然后添加调用接口请求的方法。像下面这样的代码。</p>
<p>新增的内容供应商管理模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPManager.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CPManager</span> <span class="keyword">extends</span> <span class="title">BaseModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  </span><br><span class="line">  createCp (data) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getCpPageableList (page = <span class="number">0</span>, size = <span class="number">20</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getCpFullList () &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getCp (id) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  updateCp (id, update) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  deleteCp (id) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内容标签管理模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TagManager.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagManager</span> <span class="keyword">extends</span> <span class="title">BaseModule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  </span><br><span class="line">  createTag (data) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getTagPageableList (page = <span class="number">0</span>, size = <span class="number">20</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getTagFullList () &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  getTag (id) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  updateTag (id, update) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  deleteTag (id) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增的模块远不止这些，我们发现，代码中存在很多重复的地方，比如<code>createXXX()</code>、<code>getXXX()</code>、<code>updateXXX()</code>、<code>deleteXXX()</code>，分别对应的都是模块下的CRUD接口，而且如果业务接口没有太特殊的场景时，定义一个接口，仅仅就是为了封装一个调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagManager</span> <span class="keyword">extends</span> <span class="title">BaseModule</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  createTag (data) &#123;</span><br><span class="line">    <span class="comment">// 定义createTag()方法，就是为了简化/tags的POST请求</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$http.post(<span class="string">'/tags'</span>, data)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们觉得这些重复的工作是可以简化掉的。根据方法语义化命名的习惯，创建资源的方法我们会以<code>create</code>作为前缀，对应执行<code>POST</code>请求。更新资源使用<code>update</code>作为方法名的前缀，对应执行<code>PUT</code>请求。获取资源或者资源列表，方法名以<code>get</code>开头，对应<code>GET</code>请求。删除资源，则用<code>delete</code>开头，对应<code>DELETE</code>请求。如下表所示：</p>
<table>
<thead>
<tr>
<th>方法名前缀</th>
<th>功能</th>
<th>请求方法</th>
<th>接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>创建资源</td>
<td>POST</td>
<td>/resources</td>
</tr>
<tr>
<td>get</td>
<td>获取资源</td>
<td>GET</td>
<td>/resources/:id、/resources、/resources/all</td>
</tr>
<tr>
<td>update</td>
<td>更新资源</td>
<td>PUT</td>
<td>/resources/:id</td>
</tr>
<tr>
<td>delete</td>
<td>删除资源</td>
<td>DELETE</td>
<td>/resources/:id</td>
</tr>
</tbody>
</table>
<p>按照这个约定，我们团队想，既然方法的前缀、请求方法和URL接口三者可以存在一一对应的关系，那么能不能通过<code>Key -&gt; Value</code>的方式自动化的生成与URL请求绑定好了的方法呢？</p>
<p>例如<code>TagManager</code>，我们希望通过类似下面的代码进行创建。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TagManager.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> urls = &#123;</span><br><span class="line">  createTag: <span class="string">'/tags'</span>,</span><br><span class="line">  updateTag: <span class="string">'/tags/:id'</span>,</span><br><span class="line">  getTag: <span class="string">'/tags/:id'</span>,</span><br><span class="line">  getTagPageableList: <span class="string">'/tags'</span>,</span><br><span class="line">  getTagFullList: <span class="string">'/tags/all'</span>,</span><br><span class="line">  deleteTag: <span class="string">'/tags/:id'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> moduleCreator(urls)</span><br></pre></td></tr></table></figure>
<p>然后在UI层可以直接调用创建好的模块方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// TagManager.vue</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import tagManager from &apos;./service/TagManager.js&apos;</span><br><span class="line">  // ...</span><br><span class="line">  </span><br><span class="line">  export default &#123;</span><br><span class="line">    data () &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        tagList: [],</span><br><span class="line">        page: 0,</span><br><span class="line">        size: 20,</span><br><span class="line">        // ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // ...</span><br><span class="line">    _refresh () &#123;</span><br><span class="line">      const &#123; page, size &#125; = this</span><br><span class="line">      // GET /tags?page=[page]&amp;size=[size]</span><br><span class="line">      tagManager.getTagPageableList(&#123; page, size &#125;)</span><br><span class="line">        .then(resolved =&gt; this.tagList = resolved.data)</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted () &#123;</span><br><span class="line">      this._refresh()</span><br><span class="line">    &#125;,</span><br><span class="line">    handleCreate (data) &#123;</span><br><span class="line">      // POST /tags</span><br><span class="line">      tagManager.createTag(&#123; ...data &#125;)</span><br><span class="line">        .then(_ =&gt; this._refresh())</span><br><span class="line">        .catch(err =&gt; console.error(err.message))</span><br><span class="line">    &#125;,</span><br><span class="line">    handleUpdate (id, update) &#123;</span><br><span class="line">      // PUT /tags/:id</span><br><span class="line">      tagManager.updateTag(&#123; id &#125;, &#123; ...update &#125;)</span><br><span class="line">        .then(_ =&gt; this._refresh())</span><br><span class="line">        .catch(err =&gt; console.error(err.message))</span><br><span class="line">    &#125;,</span><br><span class="line">    handleDelete (id) &#123;</span><br><span class="line">      // DELETE /tags/:id</span><br><span class="line">      tagManager.deleteTag(&#123; id &#125;)</span><br><span class="line">        .then(_ =&gt; this._refresh())</span><br><span class="line">        .catch(err =&gt; console.error(err.message))</span><br><span class="line">    &#125;,</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这样在前端定义一个业务接口的模块是不是方便多了：）而且，有没有注意到，我们对接口的传参也做了调整。无论是URL的路径变量还是查询参数，我们都可以通过对象化的方式进行传递。这种统一参数类型的调整，简化了接口的学习成本，自动生成的方法都是通过对象化的方式将参数绑定到接口当中。</p>
<blockquote>
<p>在RESTful标准的接口中，接口的URL可能会存在两种参数，<strong>路径变量</strong>（Path Variables）和<strong>查询参数</strong>（Query Argument）。</p>
<ul>
<li>路径变量：就是URL中映射到指定资源所涉及的变量，比如/resources/:id，这里的:id，指的就是资源id，操作不同的资源时，URL中:id这段路径也会不同。/resources/1，/resources/2…等</li>
<li>查询参数：指的是URL中的query参数，通常就是GET请求或者DELETE请求的URL中问号后面那段，比如/resources?page=0&amp;size=20，page和size就是查询参数</li>
</ul>
</blockquote>
<h4 id="先来一波实现的思路"><a href="#先来一波实现的思路" class="headerlink" title="先来一波实现的思路"></a>先来一波实现的思路</h4><p>首先对自动生成的与URL绑定的模块方法进行设计。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET, DELETE</span></span><br><span class="line">methodName ([params|querys:PlainObject, [querys|config:PlainObject, [config:PlainObject]]]) =&gt; :<span class="built_in">Promise</span></span><br><span class="line"><span class="comment">// POST, PUT</span></span><br><span class="line">methodName ([params|data:PlainObject, [data|config:PlainObject, [config:PlainObject]]]) =&gt; :<span class="built_in">Promise</span></span><br></pre></td></tr></table></figure>
<p>这是一段伪代码。<code>params</code>表示路径参数对象，<code>querys</code>表示<code>GET</code>或者<code>DELETE</code>请求的查询参数对象，<code>data</code>表示<code>POST</code>或者<code>PUT</code>请求提交的数据对象，大概要传达的意思是：</p>
<ul>
<li>自动生成的方法，会接受3个类型为<code>Plain Object</code>的参数，参数都是可选的，返回一个<code>Promise</code>对象。</li>
<li>当给方法传递三个参数对象的时候，参数依次是路径变量对象，查询参数对象或者数据对象，兼容<code>Axios</code>API的config对象。</li>
</ul>
<p>下面用一个<code>GET</code>请求和一个<code>PUT</code>请求进行图解示意，先看看<code>GET请求</code>：</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/16334636.jpg" alt=""></p>
<p>下面是<code>PUT</code>请求：</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/27667192.jpg" alt=""></p>
<ul>
<li>当传递两个参数时，如果URL接口不带路径变量，那么第一个参数是查询参数对象（<code>GET</code>方法或者<code>DELETE</code>方法）或者数据对象（<code>POST</code>方法或者<code>PUT</code>方法），第二个是<code>config</code>对象。如果URL接口带有路径变量，那么第一个参数就表示路径变量对象，第二个参数是查询参数对象或者数据对象。</li>
</ul>
<p>比如下面两个<code>GET</code>方法的URL接口，左边这个不带路径变量，右边的带有路径变量<code>:id</code>。左边的，假设与URL接口绑定的方法名是<code>getTagPageableList</code>，当我们调用方式只穿两个参数，那么第一个参数会转换成查询参数的格式<code>key1=value1&amp;key2=value2&amp;...&amp;keyn=valuen</code>，第二个参数则相当于<code>Axios</code>的<code>config</code>对象。右边的，因为URL接口中带有路径变量<code>:id</code>，那么调用绑定URL接口的方法<code>getTagById</code>并传了两个参数时，第一个参数对象被根据<code>key</code>替换掉URL接口中的路径变量，第二个参数则会被作为查询参数使用。</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/80722640.jpg" alt=""></p>
<p><code>POST</code>方法和<code>PUT</code>方法的请求也是类似，只是将查询参数替换成了提交的数据。</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/40980416.jpg" alt=""></p>
<ul>
<li>当只传递一个参数时，如果接口URL不带路径变量，那么这个参数就是查询参数对象或者数据对象，如果接口URL带有路径变量，那么这个参数对象就会映射到路径变量中。</li>
</ul>
<p>两个<code>GET</code>请求：</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/87216751.jpg" alt=""></p>
<p>一个<code>POST</code>请求和一个<code>PUT</code>请求：</p>
<p><img src="http://oz04bqks1.bkt.clouddn.com/18-1-2/30239455.jpg" alt=""></p>
<h4 id="将思路转换成实现的代码"><a href="#将思路转换成实现的代码" class="headerlink" title="将思路转换成实现的代码"></a>将思路转换成实现的代码</h4><p>在<code>httpclient-module</code>中实现功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 请求方法与模块方法名的映射关系对象</span></span><br><span class="line"><span class="comment"> * key -&gt; 请求方法</span></span><br><span class="line"><span class="comment"> * value -&gt; pattern：方法名的正则表达式，sendData：表示是否是POST，PUT或者PATCH方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> methodPatternMapper = &#123;</span><br><span class="line">  get: &#123; <span class="attr">pattern</span>: <span class="string">'^(get)\\w+$'</span> &#125;,</span><br><span class="line">  post: &#123; <span class="attr">pattern</span>: <span class="string">'^(create)\\w+$'</span>, <span class="attr">sendData</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  put: &#123; <span class="attr">pattern</span>: <span class="string">'^(update)\\w+$'</span>, <span class="attr">sendData</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  <span class="keyword">delete</span>: &#123; <span class="attr">pattern</span>: <span class="string">'^(delete)\\w+$'</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助方法，判断是否是函数</span></span><br><span class="line"><span class="keyword">const</span> isFunc = <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> o === <span class="string">'function'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助方法，判断是否是plain object</span></span><br><span class="line"><span class="comment">// 这个方法相对简单，如果想看更加严谨的实现，可以参考lodash的源码</span></span><br><span class="line"><span class="keyword">const</span> isObject = <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(o) === <span class="string">'[object Object]'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 将http请求绑定到模块方法中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param method 请求方法</span></span><br><span class="line"><span class="comment"> * @param moduleInstance 模块实例对象或者模块类的原型对象</span></span><br><span class="line"><span class="comment"> * @param shouldSendData 表示是否是POST，或者PUT这类请求方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return Axios请求api返回的Promise对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindModuleMethod</span>(<span class="params">method, moduleInstance, shouldSendData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">url, args, config = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> p = <span class="literal">undefined</span></span><br><span class="line">      config = &#123; ...config, url, method &#125;</span><br><span class="line">      <span class="keyword">if</span> (args) &#123;</span><br><span class="line">        shouldSendData ?</span><br><span class="line">          config.data = args :</span><br><span class="line">          config.url = <span class="string">`<span class="subst">$&#123;config.url&#125;</span>?<span class="subst">$&#123;qs.stringify(args)&#125;</span>`</span></span><br><span class="line">      &#125;</span><br><span class="line">      moduleInstance.$http.request(config)</span><br><span class="line">        .then(<span class="function"><span class="params">response</span> =&gt;</span> resolve(response))</span><br><span class="line">        .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> reject(error))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 根据定义的模块方法名称，通过methodPatternMapper转换成绑定URL的模块方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param moduleInstance 模块实例对象或者模块类的原型对象</span></span><br><span class="line"><span class="comment"> * @param name 模块方法名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return Function 绑定的模块方法</span></span><br><span class="line"><span class="comment"> * @throw 方法名称和请求方法必须一一匹配</span></span><br><span class="line"><span class="comment"> *        如果发现匹配到的方法不止1个或者没有，则会抛出异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveMethodByName</span>(<span class="params">moduleInstance, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> requestMethod = <span class="built_in">Object</span>.keys(metherPatternMapper).filter(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; pattern &#125; = methodPatternMapper[key]</span><br><span class="line">    <span class="keyword">if</span> (!(pattern <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>)) &#123;</span><br><span class="line">      <span class="comment">// methodPatternMapper每个属性的value的pattern</span></span><br><span class="line">      <span class="comment">// 既可以是正则表达式字符串，也可是是正则类型的对象</span></span><br><span class="line">      pattern = <span class="keyword">new</span> <span class="built_in">RegExp</span>(pattern)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pattern.test(name)</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (requestMethod.length !== <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">`</span></span><br><span class="line"><span class="string">      解析<span class="subst">$&#123;name&#125;</span>异常，解析得到的方法有且只能有1个，</span></span><br><span class="line"><span class="string">      但实际解析到的方法个数是：<span class="subst">$&#123;requestMethod.length&#125;</span></span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  requestMethod = requestMethod[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">return</span> bindModuleMethod(requestMethod, moduleInstance,</span><br><span class="line">                          methodPatternMapper[requestMethod].sendData)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将参数映射到路径变量</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param url</span></span><br><span class="line"><span class="comment"> * @param params 被映射到路径变量的参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return 将路径变量替换好的URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapParamsToPathVariables</span>(<span class="params">url, params</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!url || <span class="keyword">typeof</span> url !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`url <span class="subst">$&#123;url&#125;</span> 应该是URL字符串`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> url.replace(<span class="regexp">/:(\w+)/ig</span>, (_, key) =&gt; params[key])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">bindUrls</span> (<span class="params">urls = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 为什么返回一个函数对象？后面会给大家解释</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(urls)</span><br><span class="line">    <span class="keyword">if</span> (!keys.length) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">'urls对象为空，无法完成URL的映射'</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> instance = <span class="built_in">module</span>.prototype || <span class="built_in">module</span></span><br><span class="line">    </span><br><span class="line">    keys.forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> url = urls[name]</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!url) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;name&#125;</span>()的地址无效`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 根据urls对象动态定义模块方法</span></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(instance, name, &#123;</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        writable: <span class="literal">true</span>,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        value: <span class="function">(<span class="params">(url, func, thisArg</span>) =&gt;</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">let</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>)</span><br><span class="line">          <span class="keyword">if</span> (args.length &gt; <span class="number">0</span> &amp;&amp; url.indexOf(<span class="string">'/:'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isObject(args[<span class="number">0</span>])) &#123;</span><br><span class="line">              <span class="keyword">const</span> params = args[<span class="number">0</span>]</span><br><span class="line">              args = args.slice(<span class="number">1</span>)</span><br><span class="line">              url = mapParamsToPathVariables(url, params)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> func &amp;&amp; func.apply(thisArg, [ url ].concat(args))</span><br><span class="line">        &#125;)(url, resolveMethodByName(instance, name), instance)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了阅读方便，我把关键的几个地方都放到了一起，但在实际项目当中，建议适当的拆分一下代码，以便维护和测试。</p>
<p>我们实现了一个将URL请求与模块实例方法进行绑定的函数<code>bindUrls()</code>，并通过<code>httpclient-module</code>导出。<code>bundUrls()</code>的实现并不复杂。<code>urls</code>是一个以方法名作为<code>key</code>，URL作为<code>value</code>的对象。对<code>urls</code>对象进行遍历，遍历过程中，先用对象的<code>key</code>进行正则匹配，从而得到是相应的请求方法（见<code>methodPatternMapper</code>），并将请求绑定到一个函数中（见<code>resolveMethodByName()</code>和<code>bindModuleMethod()</code>）。然后通过<code>Object.defineProperty()</code>方法给模块的实例（或者原型）对象添加方法，方法的名称就是<code>urls</code>的<code>key</code>。被动态添加到模块实例对象的方法在被调用时，先判断与方法绑定的URL是否有路径变量，如果有，则通过<code>mapParamsToPathVariables()</code>进行转换，然后在执行之前通过<code>resolveMethodByName()</code>得到的已经和请求绑定好的函数。</p>
<p>我们用<code>bindUrls()</code>对之前的<code>TagManager</code>进行改造。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// TagManager.js</span><br><span class="line">// ...</span><br><span class="line"><span class="addition">+ import &#123; bindUrls &#125; from 'httpclient-module'</span></span><br><span class="line"></span><br><span class="line">class TagManager extends BaseModule &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    /* ... */</span><br><span class="line"><span class="addition">+    bindUrls(&#123;</span></span><br><span class="line"><span class="addition">+      createTag: '/tags',</span></span><br><span class="line"><span class="addition">+      getTagPageableList: '/tags',</span></span><br><span class="line"><span class="addition">+      getTagFullList: '/tags/all',</span></span><br><span class="line"><span class="addition">+      getTag: '/tags/:id',</span></span><br><span class="line"><span class="addition">+      updateTag: '/tags/:id',</span></span><br><span class="line"><span class="addition">+      deleteTag: '/tags/:id'</span></span><br><span class="line"><span class="addition">+    &#125;)(this)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="deletion">-  createTag (data) &#123; /* ... */ &#125;</span></span><br><span class="line"><span class="deletion">-  getTagPageableList (page = 0, size = 20) &#123; /* ... */ &#125;</span></span><br><span class="line"><span class="deletion">-  getTagFullList () &#123; /* ... */ &#125;</span></span><br><span class="line"><span class="deletion">-  getTag (id) &#123; /* ... */ &#125;</span></span><br><span class="line"><span class="deletion">-  updateTag (id, update) &#123; /* ... */ &#125;</span></span><br><span class="line"><span class="deletion">-  deleteTag (id) &#123; /* ... */ &#125;</span></span><br><span class="line">  </span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么<code>bindUrls()</code>要返回一个函数，通过返回的函数处理<code>module</code>这个参数，而不是将<code>module</code>作为<code>bindUrls</code>的第二个参数进行处理呢？</p>
<p>这样做的目的在于考虑兼容ES7装饰器<a href="http://es6.ruanyifeng.com/#docs/decorator" target="_blank" rel="noopener">@decorator</a>的写法。在ES7的环境中，我们还可以用装饰器来将URL绑定到模块方法中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bindUrls &#125; <span class="keyword">from</span> <span class="string">'httpclient-module'</span></span><br><span class="line"></span><br><span class="line">@bindUrls(&#123;</span><br><span class="line">  createTag: <span class="string">'/tags'</span>,</span><br><span class="line">  getTagPageableList: <span class="string">'/tags'</span>,</span><br><span class="line">  getTagFullList: <span class="string">'/tags/all'</span>,</span><br><span class="line">  getTag: <span class="string">'/tags/:id'</span>,</span><br><span class="line">  updateTag: <span class="string">'/tags/:id'</span>,</span><br><span class="line">  deleteTag: <span class="string">'/tags/:id'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagManager</span> <span class="keyword">extends</span> <span class="title">BaseModule</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，我们可以通过<code>bindUrls()</code>，方便的给模块添加一系列可以执行URL请求的实例方法。</p>
<h4 id="提升bindUrls-的灵活度"><a href="#提升bindUrls-的灵活度" class="headerlink" title="提升bindUrls()的灵活度"></a>提升bindUrls()的灵活度</h4><p><code>bindUrls()</code>灵活度还有提升的空间。现在的版本对<code>urls</code>这个参数只能支持字符串类型的<code>value</code>，我们觉得<code>urls</code>的<code>value</code>除了可以是字符串外，还可以是其他类型，比如<code>plain object</code>。同时，<code>key</code>的前缀只能是<code>create</code>、<code>update</code>、<code>get</code>、<code>delete</code>四个，感觉有些死板，我们想可以支持更多的前缀，或者说方法的名称不一定要局限于某种格式，可以自由的给方法命名。</p>
<p>我们对现在的版本进行一些小改动，提升<code>bindUrls()</code>的灵活度。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">// ...</span><br><span class="line"></span><br><span class="line">// 支持更多的前缀</span><br><span class="line">const methodPatternMapper = &#123;</span><br><span class="line"><span class="deletion">-  get: &#123; pattern: '^(get)\\w+$' &#125;,</span></span><br><span class="line"><span class="addition">+  get: &#123; pattern: '^(get|load|query|fetch)\\w+$' &#125;,</span></span><br><span class="line"><span class="deletion">-  post: &#123; pattern: '^(create)\\w+$', sendData: true &#125;,</span></span><br><span class="line"><span class="addition">+  post: &#123; pattern: '^(create|new|post)\\w+$', sendData: true &#125;,</span></span><br><span class="line"><span class="deletion">-  put: &#123; pattern: '^(update)\\w+$', sendData: true &#125;,</span></span><br><span class="line"><span class="addition">+  put: &#123; pattern: '^(update|edit|modify|put)\\w+$', sendData: true &#125;,</span></span><br><span class="line"><span class="deletion">-  delete: &#123; pattern: '^(delete)\\w+$' &#125;</span></span><br><span class="line"><span class="addition">+  delete: &#123; pattern: '^(delete|remove)\\w+$' &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ... */</span><br><span class="line"></span><br><span class="line"><span class="addition">+ function resolveMethodByRequestMethod(moduleInstance, requestMethod) &#123;</span></span><br><span class="line"><span class="addition">+   if (/^(post|put)$/.test(requestMethod)) &#123;</span></span><br><span class="line"><span class="addition">+     return bindModuleMethod(requestMethod, moduleInstance, true)</span></span><br><span class="line"><span class="addition">+   &#125; else if (/^(delete|get)$/.test(requestMethod)) &#123;</span></span><br><span class="line"><span class="addition">+     return bindModuleMethod(requestMethod, moduleInstance)</span></span><br><span class="line"><span class="addition">+   &#125; else &#123;</span></span><br><span class="line"><span class="addition">+     throw new Error(`未知的请求方法: $&#123;requestMethod&#125;`)</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br><span class="line"></span><br><span class="line">export function mapUrls (urls = &#123;&#125;) &#123;</span><br><span class="line">  return module =&gt; &#123;</span><br><span class="line">    const keys = Object.keys(urls)</span><br><span class="line">    if (!keys.length) &#123;</span><br><span class="line">      console.warn('urls对象为空，无法完成URL的映射')</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    const instance = module.prototype || module</span><br><span class="line">    </span><br><span class="line">    keys.forEach(name =&gt; &#123;</span><br><span class="line">      let url = urls[name]</span><br><span class="line"><span class="addition">+      let requestMethod = undefined</span></span><br><span class="line"><span class="addition">+      if (isObject(url)) &#123;</span></span><br><span class="line"><span class="addition">+        requestMethod = url['method']</span></span><br><span class="line"><span class="addition">+        url = url['url']</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"></span><br><span class="line">      if (!url) &#123;</span><br><span class="line">        throw new Error(`$&#123;name&#125;()的地址无效`)</span><br><span class="line">      &#125;</span><br><span class="line">	  </span><br><span class="line"><span class="addition">+      let func = undefined</span></span><br><span class="line"><span class="addition">+      if (!requestMethod) &#123;</span></span><br><span class="line"><span class="addition">+        func = resolveMethodByName(instance, name)</span></span><br><span class="line"><span class="addition">+      &#125; else &#123;</span></span><br><span class="line"><span class="addition">+        func = resolveMethodByRequestMethod(instance, requestMethod)</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line">      </span><br><span class="line">      Object.defineProperty(instance, name, &#123;</span><br><span class="line">        configurable: true,</span><br><span class="line">        writable: true,</span><br><span class="line">        enumerable: true,</span><br><span class="line">        value: ((url, func, thisArg) =&gt; () =&gt; &#123;</span><br><span class="line">          let args = Array.prototype.slice.call(arguments)</span><br><span class="line">          if (args.length &gt; 0 &amp;&amp; url.indexOf('/:') &gt;= 0) &#123;</span><br><span class="line">          	if (isObject(args[0])) &#123;</span><br><span class="line">          	  const params = args[0]</span><br><span class="line">          	  args = args.slice(1)</span><br><span class="line">          	  url = mapParamsToUrlPattern(url, params)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          return func &amp;&amp; func.apply(thisArg, [ url ].concat(args))</span><br><span class="line"><span class="deletion">-        &#125;)(url, resolveMethodByName(instance, name), instance)</span></span><br><span class="line"><span class="addition">+        &#125;)(url, func, instance)</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过调整的<code>bindUrls()</code>对<code>urls</code>支持<code>plain object</code>类型的<code>value</code>。<code>plain object</code>类型的<code>value</code>可以有两个<code>key</code>，一个是<code>url</code>，就是接口的URL，另一个是<code>method</code>，可以指定请求方法。如果设置了<code>method</code>，那么就不需要根据<code>urls</code>的<code>key</code>的前缀推导请求方法了，这样可以使得配置<code>urls</code>更加灵活。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> urls = &#123;</span><br><span class="line">  loadUsers: <span class="string">'/users'</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> urls = &#123;</span><br><span class="line">  users: &#123; <span class="attr">url</span>: <span class="string">'/users'</span>, <span class="attr">method</span>: <span class="string">'get'</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bindUrls(urls)(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.users(&#123; <span class="attr">page</span>: <span class="number">1</span>, <span class="attr">size</span>: <span class="number">20</span> &#125;) <span class="comment">// =&gt; GET /users?page=1&amp;size=20</span></span><br></pre></td></tr></table></figure>
<p>现在，我们只需要通过<code>bindUrls()</code>，简单的定义一个对象，就可以给一个模块添加请求接口的方法了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>回顾一些我们对<code>Axios</code>这个http库封装的几个阶段</p>
<ul>
<li>定义一个模块，比如<code>UserManager</code>，然后给模块添加一些调用URL接口的方法，规定好参数，然后在界面层可以通过模块的方法来调用URL接口与后台进行数据通信，简化了调用http库API的流程。</li>
<li>假如项目中，接口越来越多，那么会导致相应的模块也越来越多，比如<code>VideoManager</code>、<code>EpisodeManager</code>、<code>CPManager</code>等。随着模块模块逐渐增多，我们发现重复的代码也在增多，需要提升代码的复用性，那么，可以给这些Manager模块定义一个基类<code>BaseModule</code>，然后将http库相关的代码转移到<code>BaseModule</code>中，从而子类中调用URL接口的方法。</li>
<li>后来发现，即使有了<code>BaseModule</code>消除了重复的代码，但还是存在重复的工作，比如手写那些CRUD方法，于是，我们将<code>BaseModule</code>独立成一个单独的项目<code>httpclient-module</code>，从之前的继承关系转为组合关系，并设计了一个API<code>bindUrls()</code>。通过这个API，我们可以以<code>key -&gt; value</code>这种配置项的方式，动态的给一个模块添加执行URL接口请求的方法，从而进一步的简化我们的代码，提升我们开发的效率。</li>
<li>最后，还给<code>bindUrls()</code>做了灵活性的提升工作。</li>
</ul>
<p>在整个http封装过程中，我们进行了一些思考，比如复用性，通用性，灵活性。其最终的目的是为了提升我们开发过程的效率，减少重复工作。但回过头来看，对于http库的封装其实并非一定要做到最后这一步的样子。我们也是根据实际情况一步一步迭代过来的，所以，具体需要封装到哪一程度，并没有确切的答案，得从实际的场景出发，综合考虑后，选择最合适的方式。</p>
<p>另外的，其实整个过程的思考（不是代码），不仅仅适用于<code>Axios</code>库，也可以用于其他的http库，比如<code>SuperAgent</code>或者<code>fetch</code>，也不仅仅适用于http库的封装，封装其他类型的模块也同样适用，只是需要触类旁通。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/http-axios-ajax-前端/" rel="tag"># http, axios, ajax, 前端</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/10/developing-a-cli-on-nodejs/" rel="next" title="基于node.js平台的脚手架开发经历">
                <i class="fa fa-chevron-left"></i> 基于node.js平台的脚手架开发经历
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Forcs Zhang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对http库进行基本的封装"><span class="nav-number">2.</span> <span class="nav-text">对http库进行基本的封装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端URL接口的定义"><span class="nav-number">2.0.1.</span> <span class="nav-text">服务端URL接口的定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将接口进行模块化封装"><span class="nav-number">2.0.2.</span> <span class="nav-text">将接口进行模块化封装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#前端调用封装的方法"><span class="nav-number">2.0.3.</span> <span class="nav-text">前端调用封装的方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让封装的模块更具备复用性"><span class="nav-number">3.</span> <span class="nav-text">让封装的模块更具备复用性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用继承的方式进行重构"><span class="nav-number">3.0.1.</span> <span class="nav-text">使用继承的方式进行重构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BaseModule的问题"><span class="nav-number">3.0.2.</span> <span class="nav-text">BaseModule的问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让封装的模块更具备通用性"><span class="nav-number">4.</span> <span class="nav-text">让封装的模块更具备通用性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#对BaseModule进行重构"><span class="nav-number">4.0.1.</span> <span class="nav-text">对BaseModule进行重构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#独立发布重构的封装模块"><span class="nav-number">4.0.2.</span> <span class="nav-text">独立发布重构的封装模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对业务接口层的模块进行调整"><span class="nav-number">4.0.3.</span> <span class="nav-text">对业务接口层的模块进行调整</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让封装的模块提高我们开发效率"><span class="nav-number">5.</span> <span class="nav-text">让封装的模块提高我们开发效率</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#先来一波实现的思路"><span class="nav-number">5.0.1.</span> <span class="nav-text">先来一波实现的思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将思路转换成实现的代码"><span class="nav-number">5.0.2.</span> <span class="nav-text">将思路转换成实现的代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#提升bindUrls-的灵活度"><span class="nav-number">5.0.3.</span> <span class="nav-text">提升bindUrls()的灵活度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Forcs Zhang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
